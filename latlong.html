<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
          jQuery.ajaxSetup({
              async: false
          });
            function getLinkList() {

                var linkList = [];
                $.getJSON("http://api.teleport.org/api/urban_areas/", function(json) {
                    for (var i = 0; i < json['count']; i++) {
                        linkList.push(json['_links']['ua:item'][i]['href']);
                    }
                });
                return linkList;
            }

            //returns either a list of city names, latitudes, or longitudes
            function getCityInfo(array, request) {

                var cityInfoList = [];
                for (var i = 0; i < array.length; i++) {
                    $.getJSON(array[i], function(json) {
                        if (request == 'cityName') {
                            cityInfoList.push(json['full_name']);
                        } else if (request == 'latCoord') {
                            cityInfoList.push(json['bounding_box']['latlon']['north']);
                        } else {
                            cityInfoList.push(json['bounding_box']['latlon']['east']);
                        }
                    });
                }
                return cityInfoList;
            }

            //returns a list of city details (eg: list of unemployment rates) depending on what the user wants to view about each city
            function getCityDetails(array, request) {
              var cityDetailsList = [];
                var jsonObject, jsonObject2;
                var pushObject;
                for (var i = 0; i < array.length; i++) {
                    $.getJSON(array[i] + 'details/', function(json) {
                        if (request == 'exchangeRate') {
                            jsonObject = json['categories'][5]['data'][1]['float_value'];
                            jsonObject2 = json['categories'][5]['data'][0]['string_value'];
                            if (jsonObject == undefined || jsonObject2 == undefined) {
                                pushObject = 'info unavailible';
                            } else {
                                pushObject = ((jsonObject).toFixed(2)).toString() + " " + jsonObject2;
                            }
                        } else if (request == 'gdpGrowthRate') {
                            jsonObject = json['categories'][5]['data'][2]['percent_value'];
                            if (jsonObject == undefined) {
                                pushObject = 'info unavailible';
                            } else {
                                pushObject = (((jsonObject) * 100).toFixed(2)).toString() + "%";
                            }
                        } else if (request == 'gdpPerCapita') {
                            jsonObject = json['categories'][5]['data'][4]['currency_dollar_value'];
                            if (jsonObject == undefined) {
                                pushObject = 'info unavailible';
                            } else {
                                pushObject = "$" + ((jsonObject).toFixed(2)).toString();
                            }
                        } else if (request == 'apartmentRentSmall') {
                            jsonObject = json['categories'][8]['data'][2]['currency_dollar_value'];
                            if (jsonObject == undefined) {
                                pushObject = 'info unavailible';
                            } else {
                                pushObject = "$" + ((jsonObject).toFixed(2)).toString();
                            }
                        } else if (request == 'apartmentRentMed') {
                            jsonObject = json['categories'][8]['data'][1]['currency_dollar_value'];
                            if (jsonObject == undefined) {
                                pushObject = 'info unavailible';
                            } else {
                                pushObject = "$" + ((jsonObject).toFixed(2)).toString();
                            }
                        } else if (request == 'apartmentRentLarge') {
                            jsonObject = json['categories'][8]['data'][0]['currency_dollar_value'];
                            if (jsonObject == undefined) {
                                pushObject = 'info unavailible';
                            } else {
                                pushObject = "$" + ((jsonObject).toFixed(2)).toString();
                            }
                        } else {
                            jsonObject = json['categories'][9]['data'][3]['percent_value'];
                            if (jsonObject == undefined) {
                                pushObject = 'info unavailible';
                            } else {
                                pushObject = (((jsonObject) * 100).toFixed(2)).toString() + "%";
                            }
                        }
                        cityDetailsList.push(pushObject);
                    });
                }
                return cityDetailsList;
            }
            function setInfoWindow(index,map){
              var latCoordList = getCityInfo(getLinkList(), 'latCoord')
              var longCoordList = getCityInfo(getLinkList(), 'longCoord')
              var cityNamesList = getCityInfo(getLinkList(), 'cityName')
              var exchangeRateList = getCityDetails(getLinkList(), 'exchangeRate')
              var newPosition = {
                  lat: latCoordList[index],
                  lng: longCoordList[index]
              };
              var marker = new google.maps.Marker({
                  position: newPosition,
                  map: map
              });
              var infowindow = new google.maps.InfoWindow({
                content: cityNamesList[index] + ' '+ exchangeRateList[index]
              })
              marker.addListener('click', function() {
                  infowindow.open(map, this);
              });
            }

            window.initMap = function () {
                  var uluru = {
                      lat: 0,
                      lng: 0
                  };
                  var map = new google.maps.Map(document.getElementById('map'), {
                      zoom: 2,
                      center: uluru
                  });

              for (var j=0; j<5; j++){
                setInfoWindow(j,map);
              }

              }



                /*console.log(getCityInfo(getLinkList(), 'cityName'));
                console.log(getCityInfo(getLinkList(), 'latCoord'));
                console.log(getCityInfo(getLinkList(), 'longCoord'));
                console.log(getCityDetails(getLinkList(), 'exchangeRate'));
                console.log(getCityDetails(getLinkList(), 'gdpGrowthRate'));
                console.log(getCityDetails(getLinkList(), 'gdpGrowthRate'));
                console.log(getCityDetails(getLinkList(), 'gdpPerCapita'));
                console.log(getCityDetails(getLinkList(), 'apartmentRentSmall'));
                console.log(getCityDetails(getLinkList(), 'apartmentRentMed'));
                console.log(getCityDetails(getLinkList(), 'apartmentRentLarge'));
                console.log(getCityDetails(getLinkList(), 'unemployment'));*/
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3mKlzdgbZFNvxCvcjO4nilUkpAtvIxfM&callback=initMap"></script>
</body>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
</body>

</html>
